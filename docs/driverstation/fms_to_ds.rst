FMS to Driver Station
=====================

.. _fms_ds_udp:

UDP
---

Sent to the DS on UDP port 1121 by the FMS every 500ms. (Was 1120, changed at some point?)

.. table::
   :widths: auto

   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Field            | Length | Type                                              | Comment                                                  |
   +==================+========+===================================================+==========================================================+
   | Sequence Num     | 2      | uint16                                            |                                                          |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Comm Version     | 1      | uint8                                             | Only `0x00` has been observed                            |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Control Byte     | 1      | :ref:`Control <fms_ds_control>`                   | Contains control bits                                    |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Request Byte     | 1      | Request                                           | Stays at `0x00`, not used                                |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Alliance Station | 1      | :ref:`Alliance Station <fms_ds_alliance_station>` | Represents the station the DS connects to                |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Tournament Level | 1      | :ref:`Tournament Level <fms_ds_tournament_level>` | What level of competition this is                        |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Match Number     | 2      | uint16                                            | Represents the number of current match                   |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Play Number      | 1      | uint8                                             | Increments if there's a replay                           |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Date             | 10     | :ref:`Date <fms_ds_date>`                         |                                                          |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Remaining Time   | 2      | uint16                                            | Time left in current mode                                |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+
   | Tags             | n      | Tags                                              | Offseason FMS has code for sending tags but none to send |
   +------------------+--------+---------------------------------------------------+----------------------------------------------------------+

.. _fms_ds_control:

Control
^^^^^^^

.. table::
   :widths: auto

   +---------+--------------+-----------------------------------+
   | Field   | Mask         | Comment                           |
   +---------+--------------+-----------------------------------+
   | E-Stop  | ``x.......`` | 0: Normal, 1: Emergency Stopped   |
   +---------+--------------+-----------------------------------+
   | Enabled | ``.....x..`` | 0: Disabled, 1: Enabled           |
   +---------+--------------+-----------------------------------+
   | Mode    | ``......xx`` | 0: TeloOp, 1: Test, 2: Autonomous |
   +---------+--------------+-----------------------------------+

.. _fms_ds_alliance_station:

Alliance Station
^^^^^^^^^^^^^^^^

Computed by taking station [1, 3] and subtracting 1 for red, or adding 2 for blue.
Color is Red if ``value < 3``, else Blue. Position is ``value % 3 + 1``

.. _fms_ds_tournament_level:

Tournament Level
^^^^^^^^^^^^^^^^

.. table::
   :widths: auto

   +---------------+-------+-------------------------------------------------+
   | Level         | Value | Comment                                         |
   +===============+=======+=================================================+
   | Match Test    | 0     | Only used during FMS setup for testing purposes |
   +---------------+-------+-------------------------------------------------+
   | Practice      | 1     |                                                 |
   +---------------+-------+-------------------------------------------------+
   | Qualification | 2     |                                                 |
   +---------------+-------+-------------------------------------------------+
   | Playoff       | 3     |                                                 |
   +---------------+-------+-------------------------------------------------+

.. _fms_ds_date:

Date
^^^^

.. table::
   :widths: auto

   +--------------+--------+--------+-------------------------+
   | Field        | Length | Type   | Comment                 |
   +==============+========+========+=========================+
   | Microseconds | 4      | uint32 |                         |
   +--------------+--------+--------+-------------------------+
   | Second       | 1      | uint8  |                         |
   +--------------+--------+--------+-------------------------+
   | Minute       | 1      | uint8  |                         |
   +--------------+--------+--------+-------------------------+
   | Hour         | 1      | uint8  | In UTC?                 |
   +--------------+--------+--------+-------------------------+
   | Day          | 1      | uint8  |                         |
   +--------------+--------+--------+-------------------------+
   | Month        | 1      | uint8  | 0 is January            |
   +--------------+--------+--------+-------------------------+
   | Year         | 1      | uint8  | Year (starting at 1900) |
   +--------------+--------+--------+-------------------------+

.. _fms_ds_tcp:

TCP
---

``10.0.100.5``, listening on TCP port 1750.

.. table::
   :widths: auto

   +-------+--------+--------+------------------------------------+
   | Field | Length | Type   | Comment                            |
   +=======+========+========+====================================+
   | Size  | 2      | uint16 | Including ID                       |
   +-------+--------+--------+------------------------------------+
   | ID    | 1      | uint8  | See table below (only of Size > 0) |
   +-------+--------+--------+------------------------------------+
   | Tags  | n      |        | Depends on tag type                |
   +-------+--------+--------+------------------------------------+

.. _fms_ds_tcp_tags:

Tags
^^^^

.. table::
   :widths: auto

   +----------+-------------------------------------------------------+
   | ID       | Tag                                                   |
   +==========+=======================================================+
   | ``0x00`` | :ref:`WPILib Version <fms_ds_version>`                |
   +----------+-------------------------------------------------------+
   | ``0x01`` | :ref:`RIO Version <fms_ds_version>`                   |
   +----------+-------------------------------------------------------+
   | ``0x02`` | :ref:`DS Version <fms_ds_version>`                    |
   +----------+-------------------------------------------------------+
   | ``0x03`` | :ref:`PDP Version <fms_ds_version>`                   |
   +----------+-------------------------------------------------------+
   | ``0x04`` | :ref:`PCM Version <fms_ds_version>`                   |
   +----------+-------------------------------------------------------+
   | ``0x05`` | :ref:`CANJag Version <fms_ds_version>`                |
   +----------+-------------------------------------------------------+
   | ``0x06`` | :ref:`CANTalon Version <fms_ds_version>`              |
   +----------+-------------------------------------------------------+
   | ``0x07`` | :ref:`Third Party Device Version <fms_ds_version>`    |
   +----------+-------------------------------------------------------+
   | ``0x14`` | :ref:`Event Code <fms_ds_event_code>`                 |
   +----------+-------------------------------------------------------+
   | ``0x19`` | :ref:`Station Info <fms_ds_station_info>`             |
   +----------+-------------------------------------------------------+
   | ``0x1a`` | :ref:`Challenge Question <fms_ds_challenge_question>` |
   +----------+-------------------------------------------------------+
   | ``0x1c`` | :ref:`Game Data <fms_ds_game_data>`                   |
   +----------+-------------------------------------------------------+

Versions all take the same format

.. _fms_ds_version:

Version
"""""""

See above table for devices and their associated tag IDs. Seems only the "preferred" DS version is sent to the Driver Station.

.. table::
   :widths: auto

   +---------+--------+--------+-------------------------------------+
   | Field   | Length | Type   | Comment                             |
   +=========+========+========+=====================================+
   | Status  | n      | string | `<bad>`, `<good>`, or `<preferred>` |
   +---------+--------+--------+-------------------------------------+
   | Version | n      | string |                                     |
   +---------+--------+--------+-------------------------------------+

.. _fms_ds_event_code:

Event Code (``0x14``)
"""""""""""""""""""""

.. table::
   :widths: auto

   +------------+--------+--------+------------+
   | Field      | Length | Type   | Comment    |
   +============+========+========+============+
   | Event Code | 1 + n  | string | Event name |
   +------------+--------+--------+------------+

.. _fms_ds_station_info:

Station Info (``0x19``)
"""""""""""""""""""""""

.. table::
   :widths: auto

   +------------------+--------+---------------------------------------------------+---------+
   | Field            | Length | Type                                              | Comment |
   +------------------+--------+---------------------------------------------------+---------+
   | Alliance Station | 1      | :ref:`Alliance Station <fms_ds_alliance_station>` |         |
   +------------------+--------+---------------------------------------------------+---------+
   | Station Status   | 1      | :ref:`Station Status <fms_ds_station_status>`     |         |
   +------------------+--------+---------------------------------------------------+---------+

.. _fms_ds_station_status:

Station Status
..............

.. table::
   :widths: auto

   +-----+---------+-----------------------------------------------------------------------------------------------------------------+
   | Num | Status  | Comment                                                                                                         |
   +=====+=========+=================================================================================================================+
   | 0   | Good    | Sent if FMS Driver Station context is valid. Causes the DS to display "FMS Connected"                           |
   +-----+---------+-----------------------------------------------------------------------------------------------------------------+
   | 1   | Bad     | Sent if the Driver Station is plugged into the wrong station. Causes the DS to display "Wrong station. Go to X" |
   +-----+---------+-----------------------------------------------------------------------------------------------------------------+
   | 2   | Waiting | Sent if FMS Driver Station context is invalid. Causes the DS to display "FMS Waiting"                           |
   +-----+---------+-----------------------------------------------------------------------------------------------------------------+


.. _fms_ds_challenge_question:

Challenge Question (``0x1a``)
"""""""""""""""""""""""""""""

.. table::
   :widths: auto

   +--------------+--------+--------+---------------------------------------------------------------------------+
   | Field        | Length | Type   | Comment                                                                   |
   +==============+========+========+===========================================================================+
   | Question     | 1 + n  | string | `Coolest robot EVER!!??`                                                  |
   +--------------+--------+--------+---------------------------------------------------------------------------+
   | Random Value | 2      | uint16 | Random number [1000, 2000] associated with the FMS Driver Station context |
   +--------------+--------+--------+---------------------------------------------------------------------------+

Offseason FMS allows for sending multiple questions, but the responses are only checked against the first one (as of 2018).

See the :ref:`Challenge Response <ds_fms_challenge_response>` for possible responses.

.. _fms_ds_game_data:

Game Data (``0x1c``)
""""""""""""""""""""

.. table::
   :widths: auto

   +-------+--------+--------+---------+
   | Field | Length | Type   | Comment |
   +=======+========+========+=========+
   | Data  | 1 + n  | string |         |
   +-------+--------+--------+---------+
